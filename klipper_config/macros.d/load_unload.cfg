[gcode_macro UNLOAD_FILAMENT]
gcode:
  SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT

  M83           ; Relative extrusion
  G1 E-5 F300   ; Retract 5mm slowly
  G1 E4.5 F1200 ; Dip to remove string
  G1 E-90 F1200 ; Fast full retract

  RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT
